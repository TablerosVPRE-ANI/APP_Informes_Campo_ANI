<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#004884">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <title>ANI Comisiones -</title>
</head>
<body>
    <div class="header">
        <div class="logo-section">
            <div class="logo">ANI</div>
            <div class="header-info">
                <h1>ANI Campo</h1>
                <p id="projectInfo">Sistema de Informes de Campo</p>
            </div>
        </div>
        <div class="user-section">
            <div class="user-info" id="userInfo" style="text-align: right; margin-right: 15px;">
                <div class="user-name" id="userName" style="font-weight: 600; font-size: 14px; color: white;">Usuario</div>
                <div class="user-git" id="userGit" style="font-size: 12px; opacity: 0.8; color: white;">GIT</div>
            </div>
            <div>
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="connectionText" style="font-size: 12px;"></span>
            </div>
            <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-left: 10px;" title="Cerrar Sesión">
                🚪
            </button>
            <button id="adminBtn" onclick="goToAdmin()" style="display: none; background: #ff6b6b; border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-left: 10px;" title="Administrar Usuarios">
                👥
            </button>
        </div>
    </div> <!-- ESTE DIV FALTABA - Cierra el header -->

    <div id="syncStatus" class="sync-status" style="display: none;"></div>

    <!-- Sección Información Básica -->
    <div id="infoBasica" class="section active">
        <div class="form-section">
            <div class="form-title">📋 Información Básica</div>
            
            <!-- Información del usuario logueado (automática) -->
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #004884;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-weight: 600; color: #004884; display: block; margin-bottom: 5px; font-size: 13px;">
                            Funcionario Responsable:
                        </label>
                        <input type="text" id="funcionarioSession" readonly style="background: #f5f5f5; border: 1px solid #ccc; color: #333; font-weight: 500;">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #004884; display: block; margin-bottom: 5px; font-size: 13px;">
                            GIT Asignado:
                        </label>
                        <input type="text" id="gitSession" readonly style="background: #f5f5f5; border: 1px solid #ccc; color: #333; font-weight: 500;">
                    </div>
                </div>
            </div>
            
    <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">
        Nombre del Proyecto / Corredor Vial *
    </label>
    <input type="text" id="nombreProyecto" placeholder="Ej: Canal del Dique, Corredor Santana-Mocoa-Neiva" required>
            
    <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">
        Nombre del funcionario *
    </label>
    <input type="text" id="nombreFuncionario" placeholder="Nombre completo" required>
            
            <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">
                Lugar específico *
            </label>
            <input type="text" id="lugar" placeholder="Lugar específico en Cartagena" value="Cartagena" required>
            
            <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">
                Fecha de salida *
            </label>
            <input type="date" id="fechaSalida" required>
            
            <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">
                Fecha de regreso *
            </label>
            <input type="date" id="fechaRegreso" required>
            
            <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">
                Objeto del desplazamiento *
            </label>
            <textarea id="objeto" placeholder="Objeto del desplazamiento *" required></textarea>
            
            <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">
                Otros participantes
            </label>
            <input type="text" id="participantes" placeholder="Otros participantes (separar con comas)">
        </div>
    </div>

    <!-- Sección Actividades -->
    <div id="actividades" class="section">
        <div class="form-section">
            <div class="form-title">📝 Registrar Actividad</div>
            <input type="text" id="actividadTitulo" placeholder="Título de la actividad">
            <input type="datetime-local" id="actividadFecha">
            <textarea id="actividadDescripcion" placeholder="Descripción detallada"></textarea>
            
            <div style="margin: 10px 0;">
                <label style="font-size: 14px; color: #666; display: block; margin-bottom: 8px;">
                    📷 Agregar evidencias (fotos)
                </label>
                <input type="file" 
                       id="actividadFoto" 
                       accept="image/*" 
                       multiple
                       style="width: 100%; padding: 10px; border: 2px dashed #004884; border-radius: 6px; background: #f0f8ff;">
            </div>
            <p style="font-size: 12px; color: #666; margin: 5px 0;">
                Toca para seleccionar de galería o tomar foto nueva
            </p>
            
            <button class="btn btn-primary" onclick="guardarActividad()">Agregar Actividad</button>
        </div>
        <div id="listaActividades"></div>
    </div>

    <!-- Sección Compromisos -->
    <div id="compromisos" class="section">
        <div class="form-section">
            <div class="form-title">🎯 Nuevo Compromiso</div>
            <input type="text" id="compromisoDescripcion" placeholder="Descripción del compromiso">
            <select id="compromisoResponsable">
                <option value="">Seleccionar responsable...</option>
                <option value="ANI">ANI</option>
                <option value="Concesionario">Concesionario</option>
                <option value="Interventoría">Interventoría</option>
                <option value="Alcaldía">Alcaldía</option>
                <option value="Gobernación">Gobernación</option>
                <option value="Comunidad">Comunidad</option>
                <option value="Ministerio">Ministerio</option>
            </select>
            <input type="date" id="compromisoFecha">
            <select id="compromisoPrioridad">
                <option value="alta">Prioridad Alta</option>
                <option value="media">Prioridad Media</option>
                <option value="baja">Prioridad Baja</option>
            </select>
            <button class="btn btn-primary" onclick="guardarCompromiso()">Agregar Compromiso</button>
        </div>
        <div id="listaCompromisos"></div>
    </div>

    <!-- Sección Guardar -->
    <div id="guardar" class="section">
        <div class="form-section">
            <div class="form-title">💾 Opciones de Guardado</div>
            <div id="resumen"></div>
            <button class="btn btn-success" onclick="guardarInforme()">💾 Guardar Localmente</button>
            <button class="btn btn-primary" onclick="sincronizar()">☁️ Sincronizar</button>
            <button class="btn btn-secondary" onclick="exportarJSON()">📥 Descargar JSON</button>
        </div>
    </div>

    <!-- Menú flotante -->
    <div class="floating-menu">
        <button class="menu-btn active" onclick="cambiarSeccion('infoBasica', this)">
            <span style="font-size: 24px;">📋</span>
            <span>Info</span>
        </button>
        <button class="menu-btn" onclick="cambiarSeccion('actividades', this)">
            <span style="font-size: 24px;">📝</span>
            <span>Actividades</span>
        </button>
        <button class="menu-btn" onclick="cambiarSeccion('compromisos', this)">
            <span style="font-size: 24px;">🎯</span>
            <span>Compromisos</span>
        </button>
        <button class="menu-btn" onclick="cambiarSeccion('guardar', this)">
            <span style="font-size: 24px;">💾</span>
            <span>Guardar</span>
        </button>
    </div>

    <!-- Scripts externos -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="app.js"></script>
    
    <!-- Scripts de funcionalidad -->
    <script>
        // Verificación de sesión al cargar la página
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Inicializar Supabase
                const supabaseInitialized = initSupabase();
                if (supabaseInitialized) {
                    window.APP_STATE.supabaseConnected = await testSupabaseConnection();
                }

                // Verificar sesión
                const hasSession = window.authSystem.checkExistingSession();
                
                if (!hasSession) {
                    // No hay sesión, redirigir a login
                    window.location.href = 'login.html';
                    return;
                }

                // Configurar interfaz con datos del usuario
                setupUserInterface();

            } catch (error) {
                console.error('Error al inicializar la aplicación:', error);
                alert('Error al cargar la aplicación. Será redirigido al login.');
                window.location.href = 'login.html';
            }
        });

        // Configurar interfaz con datos del usuario
        function setupUserInterface() {
            const user = window.APP_STATE.currentUser;
            if (!user) return;

            // Actualizar header
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userGit').textContent = `GIT: ${user.git}`;
            
            // Llenar campos de sesión
            document.getElementById('funcionarioSession').value = user.name;
            document.getElementById('gitSession').value = `${user.git} - ${user.git_description}`;
            
            // Mostrar botón de admin solo para superadmin
            if (user.role === 'superadmin') {
                document.getElementById('adminBtn').style.display = 'inline-block';
            }
            
            // Actualizar título de la página
            document.title = `ANI Campo - ${user.git}`;
            
            console.log(`Usuario configurado: ${user.name} (${user.git})`);
        }

        // Función para ir al administrador
        function goToAdmin() {
            window.location.href = 'admin-usuarios.html';
        }

        // Cerrar sesión
        async function logout() {
            if (confirm('¿Está seguro de que desea cerrar sesión?')) {
                await window.authSystem.logout();
                window.location.href = 'login.html';
            }
        }

        // Funciones básicas para navegación
        function cambiarSeccion(seccionId, boton) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Mostrar la sección seleccionada
            document.getElementById(seccionId).classList.add('active');
            
            // Actualizar botones del menú
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            boton.classList.add('active');
        }

    </script>
<div id="modalEdicion" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="form-title">✏️ Editar Actividad</div>
        <input type="hidden" id="editActividadId">
        
        <label>Título de la actividad</label>
        <input type="text" id="editActividadTitulo" placeholder="Título de la actividad">
        
        <label>Fecha y Hora</label>
        <input type="datetime-local" id="editActividadFecha">
        
        <label>Descripción</label>
        <textarea id="editActividadDescripcion" placeholder="Descripción detallada"></textarea>

        <label>Evidencias (Fotos)</label>
        <div id="editGaleriaFotos" class="galeria-fotos" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; min-height: 80px;">
            </div>

        <label>Añadir nuevas fotos</label>
        <input type="file" id="editActividadNuevasFotos" accept="image/*" multiple style="width: 100%;">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="cerrarModalEdicion()">Cancelar</button>
            <button class="btn btn-primary" onclick="guardarCambiosActividad()">Guardar Cambios</button>
        </div>
    </div>
</div>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('✅ Service Worker registrado con éxito.'))
      .catch(err => console.error('❌ Error al registrar Service Worker:', err));
  }
</script>
</body>
</html>















