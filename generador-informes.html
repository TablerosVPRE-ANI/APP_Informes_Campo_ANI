<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANI - Generador de Informes de Comisi√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .header {
            background: #004884;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            margin: -30px -30px 30px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #004884;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-word {
            background: #2b579a;
            color: white;
        }

        .btn-pdf {
            background: #dc3545;
            color: white;
        }

        select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 300px;
        }

        .informe-preview {
            border: 1px solid #ddd;
            padding: 40px;
            background: white;
            min-height: 800px;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }

        .informe-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .informe-table td {
            border: 1px solid #000;
            padding: 8px;
            vertical-align: top;
        }

        .informe-table td:first-child {
            font-weight: bold;
            background: #f0f0f0;
            width: 30%;
        }

        h2 {
            margin: 30px 0 15px;
            text-decoration: underline;
            font-size: 16px;
        }

        .actividad-box {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            background: #f9f9f9;
        }

        .compromiso-item {
            margin: 15px 0;
            padding: 10px;
            border-left: 3px solid #004884;
            background: #f0f8ff;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media print {
            .controls, .header { display: none; }
            .container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Generaci√≥n de Informes de Comisi√≥n</h1>
            <p>Vicepresidencia de Planeaci√≥n, Riesgos y Entorno</p>
        </div>

        <div class="controls">
            <select id="informeSelect">
                <option value="">-- Seleccionar Informe --</option>
            </select>
            <button class="btn btn-primary" onclick="cargarInforme()">üìÑ Cargar Informe</button>
            <button class="btn btn-success" onclick="generarDocumento()">‚ú® Generar Documento</button>
            <button class="btn btn-word" onclick="exportarWord()">üìù Exportar Word</button>
            <button class="btn btn-pdf" onclick="window.print()">üì• Exportar PDF</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            Cargando datos desde Supabase...
        </div>

        <div id="informeContent" class="informe-preview">
            <p style="text-align: center; color: #666;">
                Seleccione un informe de la lista para generar el documento
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuraci√≥n Supabase - REEMPLAZAR CON TUS CREDENCIALES
        const SUPABASE_URL = 'https://plcdxksctnhuclgymhqq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsY2R4a3NjdG5odWNsZ3ltaHFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU5MzA0MzIsImV4cCI6MjA1MTUwNjQzMn0.6Yb3u1leIlH-q4Zr1TQ4YZ1EMLNGyGjlu0n8s5mTEXk';

        let supabase = null;
        let informeActual = null;

        // Inicializar al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Iniciando aplicaci√≥n...');
            
            // Inicializar Supabase
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase inicializado');
                await cargarListaInformes();
            } else {
                console.error('Supabase no se carg√≥ correctamente');
                alert('Error: No se pudo cargar la biblioteca de Supabase');
            }
        });

        async function cargarListaInformes() {
            if (!supabase) {
                console.error('Supabase no est√° inicializado');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            
            try {
                console.log('Consultando informes...');
                const { data, error } = await supabase
                    .from('informes')
                    .select('*')
                    .order('fecha_creacion', { ascending: false });
                
                if (error) {
                    console.error('Error de Supabase:', error);
                    throw error;
                }
                
                console.log(`Se encontraron ${data?.length || 0} informes`);
                
                const select = document.getElementById('informeSelect');
                select.innerHTML = '<option value="">-- Seleccionar Informe --</option>';
                
                if (data && data.length > 0) {
                    data.forEach(informe => {
                        const option = document.createElement('option');
                        option.value = informe.informe_id;
                        const fecha = informe.fecha_salida || 'Sin fecha';
                        const objeto = (informe.objeto || 'Sin objeto').substring(0, 50);
                        option.textContent = `${informe.lugar} - ${fecha} - ${objeto}...`;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "No hay informes disponibles";
                    select.appendChild(option);
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar informes: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function cargarInforme() {
            const informeId = document.getElementById('informeSelect').value;
            if (!informeId) {
                alert('Por favor seleccione un informe');
                return;
            }
            
            if (!supabase) {
                alert('Error: Supabase no est√° inicializado');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            
            try {
                console.log('Cargando informe:', informeId);
                
                // Cargar informe principal
                const { data: informe, error: errorInforme } = await supabase
                    .from('informes')
                    .select('*')
                    .eq('informe_id', informeId)
                    .single();
                
                if (errorInforme) {
                    console.error('Error cargando informe:', errorInforme);
                    throw errorInforme;
                }
                
                // Cargar actividades
                const { data: actividades } = await supabase
                    .from('actividades')
                    .select('*')
                    .eq('informe_id', informeId);
                
                // Cargar compromisos
                const { data: compromisos } = await supabase
                    .from('compromisos')
                    .select('*')
                    .eq('informe_id', informeId);
                
                // Combinar todo
                informeActual = {
                    ...informe,
                    actividades: actividades || [],
                    compromisos: compromisos || []
                };
                
                // Si hay datos completos, usarlos tambi√©n
                if (informe.datos_completos) {
                    const datosCompletos = typeof informe.datos_completos === 'string' 
                        ? JSON.parse(informe.datos_completos) 
                        : informe.datos_completos;
                    
                    informeActual = {
                        ...informeActual,
                        ...datosCompletos
                    };
                }
                
                console.log('Informe cargado:', informeActual);
                mostrarInforme();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar el informe');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function mostrarInforme() {
            if (!informeActual) return;
            
            const fechaHoy = new Date().toLocaleDateString('es-CO', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="font-size: 24px;">INFORME DE COMISI√ìN</h1>
                    <p>AGENCIA NACIONAL DE INFRAESTRUCTURA<br>
                    Vicepresidencia de Planeaci√≥n, Riesgos y Entorno</p>
                </div>

                <table class="informe-table">
                    <tr>
                        <td>Fecha de elaboraci√≥n:</td>
                        <td>${fechaHoy}</td>
                    </tr>
                    <tr>
                        <td>Lugar:</td>
                        <td>${informeActual.lugar || 'No especificado'}</td>
                    </tr>
                    <tr>
                        <td>Proyecto:</td>
                        <td>${informeActual.proyecto || 'Canal del Dique'}</td>
                    </tr>
                    <tr>
                        <td>Fecha salida:</td>
                        <td>${formatearFecha(informeActual.fecha_salida)}</td>
                    </tr>
                    <tr>
                        <td>Fecha regreso:</td>
                        <td>${formatearFecha(informeActual.fecha_regreso)}</td>
                    </tr>
                    <tr>
                        <td>Participantes:</td>
                        <td>${Array.isArray(informeActual.participantes) ? informeActual.participantes.join(', ') : 'No especificados'}</td>
                    </tr>
                </table>

                <h2>Objeto del desplazamiento</h2>
                <p>${informeActual.objeto || 'No especificado'}</p>

                <h2>Actividades Desarrolladas</h2>
            `;

            // Agregar actividades
            if (informeActual.actividades && informeActual.actividades.length > 0) {
                informeActual.actividades.forEach((act, i) => {
                    html += `
                        <div class="actividad-box">
                            <strong>Actividad ${i + 1}: ${act.titulo || 'Sin t√≠tulo'}</strong><br>
                            Fecha: ${formatearFecha(act.fecha)}<br>
                            ${act.descripcion || ''}
                        </div>
                    `;
                });
            } else {
                html += '<p>No se registraron actividades</p>';
            }

            html += '<h2>Compromisos Asumidos</h2>';

            // Agregar compromisos
            if (informeActual.compromisos && informeActual.compromisos.length > 0) {
                informeActual.compromisos.forEach(comp => {
                    html += `
                        <div class="compromiso-item">
                            <strong>${comp.descripcion || 'Sin descripci√≥n'}</strong><br>
                            Responsable: ${comp.responsable || 'No asignado'} | 
                            Fecha: ${formatearFecha(comp.fecha_limite)} | 
                            Prioridad: ${comp.prioridad || 'Media'}
                        </div>
                    `;
                });
            } else {
                html += '<p>No se establecieron compromisos</p>';
            }

            html += `
                <h2>Conclusiones</h2>
                <ol>
                    <li>Se cumplieron los objetivos de la comisi√≥n en ${informeActual.lugar}.</li>
                    <li>Se ejecutaron ${informeActual.actividades?.length || 0} actividades.</li>
                    <li>Se establecieron ${informeActual.compromisos?.length || 0} compromisos para seguimiento.</li>
                </ol>
            `;

            document.getElementById('informeContent').innerHTML = html;
        }

        function formatearFecha(fecha) {
            if (!fecha) return 'No especificada';
            try {
                return new Date(fecha).toLocaleDateString('es-CO');
            } catch {
                return fecha;
            }
        }

        function generarDocumento() {
            if (!informeActual) {
                alert('Primero debe cargar un informe');
                return;
            }
            alert('Documento generado. Puede exportarlo usando los botones.');
        }

        function exportarWord() {
            if (!informeActual) {
                alert('Primero debe cargar un informe');
                return;
            }
            
            const contenido = document.getElementById('informeContent').innerHTML;
            const blob = new Blob(['\ufeff', contenido], {
                type: 'application/msword'
            });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Informe_${informeActual.lugar}_${new Date().toISOString().split('T')[0]}.doc`;
            link.click();
        }
    </script>
</body>
</html>
